
Задание
Основные данные

Необходимо написать простой веб-сервис, который будет скачивать XML-файлы 
по заданным ссылкам, парсить эти файлы и выдавать распознанные значения через API. 
Сервис должен работать асинхронно (не блокироваться при добавлении ссылок на новые файлы) 
и состоять, по меньшей мере, из следующих компонентов:

    WSGI/ASGI HTTP-сервер

    База данных

    Система для асинхронного выполнения задач, состоящая, в частности, из:

        брокера сообщений

        воркера

Сервис может быть написан на любом Python (предпочтительны Django, FastAPI или Flask) 
или JS (предпочтителен Express) web-фреймворке .
 В качестве БД может быть использована любая БД, 
 образ которой доступен в публичных Docker-регистрах, 
 или любая встраиваемая БД (SQLite, TinyDB, …​). 
 Для организации асинхронного выполнения задач также может быть использована 
 любая соответствующая библиотека (Celery, Dramatiq, huey, RQ).
 
 

Использование отдельного брокера сообщений и наличие воркера в этом задании обязательно, 
поскольку в реальных сервисах задачи отправляются на исполнение другим сервисам 
в виде сообщений по протоколу AMQP, и хотелось бы увидеть организацию проекта 
с таким разделением. Тем не менее, в задании необязательно использование именно 
AMQP-брокера, вполне достаточно Redis.

Проект должен быть организован в виде, пригодном для разворачивания через 
Docker Compose (т.е. в корневой директории проекта должен, по крайней мере, 
присутствовать docker-compose.yml с нужными контейнерами). 
Организация и состав контейнеров не принципиальны: 
сервис может быть выполнен как в виде единого контейнера 
(например, с использованием supervisord), 
так и в виде отдельных контейнеров для HTTP-сервера и воркера.


Входные XML-файлы

Входные XML-файлы доступны по следующим ссылкам:

    https://hub.b2basket.ru/media/test_problem/file_1.xml

    https://hub.b2basket.ru/media/test_problem/file_2.xml

Структура входных XML-файлов:

<?xml version="1.0" encoding="utf-8"?>
<keys>
	<key>key1</key>
	<key>key2</key>
	...
</keys>

Из XML-файлов требуется извлекать значения в полях key.

Следует сохранять информацию о том, из какого именно XML файла 
были извлечены те или иные keys, а не скидывать все ключи в одну кучу. 
(см. примеры запросов на /keys)

Спецификация API

Сервис должен иметь следующие ресурсы:

    /urls - URL’ы XML-файлов и статус их обработки (GET, POST)
    /keys - извлечённые из XML-файлов значения полей keys (GET)

POST /urls
Общая структура
Запрос

{
    "url": string
}

url

    URL, по которому может быть скачан XML-файл

Ответ

{
    "id": int,
}

id

    id мета-данных XML-файла в системе

Пример
POST /urls

{
    "url": "https://ex.amp.le/file.xml"
}

Ответ

{
    "id": 1
}

GET /urls
Общая структура
Ответ (отдельный элемент)

{
    "id": int,
    "url": string,
    "processed": bool,
    "error": string
}

id

    id мета-данных XML-файла в системе
url

    URL, по которому может быть скачан XML-файл
processed

    Флаг, отражающий, был ли XML-файл обработан сервисом
error

    Описание ошибки (если произошла)

Примеры
GET /urls
Ответ

[
    {
        "id": 1,
        "url": "https://ex.amp.le/file.xml",
        "processed": true,
        "error": ""
    },
    {
        "id": 2,
        "url": "https://ex.amp.le/file2.xml"
        "processed": false,
        "error": ""
    },
    {
        "id": 3,
        "url": "https://ex.amp.le/file3.xml"
        "processed": true,
        "error": "URL is not available"
    }
]

GET /urls/1
Ответ

{
    "id": 1,
    "url": "https://ex.amp.le/file.xml",
    "processed": true,
    "error": ""
}

GET /keys
Общая структура
Ответ (отдельный элемент)

{
    "id": int,
    "url": string,
    "keys": [
        string,
        ...
    ]
}

id

    id мета-данных XML-файла в системе
url

    URL, по которому может быть скачан XML-файл
keys

    Извлечённые из XML-файла значения полей <key>

Примеры
GET /keys
Ответ

```json
[
    {
        "id": 1,
        "url": "https://ex.amp.le/file.xml",
        "keys": [
            "b",
            "a",
            "c"
        ]
    },
    {
        "id": 2,
        "url": "https://ex.amp.le/file2.xml",
        "keys": [
            "2",
            "1"
        ]
    },
    {
        "id": 3,
        "url": "https://ex.amp.le/file3.xml",
        "keys": []
    }
]
```

GET /keys/1
Ответ

{
    "id": 1,
    "url": "https://ex.amp.le/file.xml",
    "keys": [
        "b",
        "a",
        "c"
    ]
}

Проверка решения

Для проверки правильности решения будет использован следующий скрипт:

https://hub.b2basket.ru/media/test_problem/test.sh

Этот скрипт разворачивает проект и делает необходимые запросы к развёрнутому сервису (необходимо иметь установленными curl и jq). Файл test.sh необходимо поместить в корневую директорию проекта.

Стоит отметить, что скрипт проверяет лишь правильность работы сервиса - интерес представляет также сам код, который может быть проверен только вручную.
Предоставление решения

Готовый сервис не требуется разворачивать online, достаточно предоставить доступ к исходному коду в личном git-репозитории.
Last updated 2020-07-31 15:09:00 +0300
